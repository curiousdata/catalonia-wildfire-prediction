services:
  monolith:
    build:
      context: .
      dockerfile: docker/monolith/Dockerfile
    ports:
      - "8501:8501"
    environment:
      # Dataset/model paths inside container
      - IBERFIRE_ZARR_PATH=/app/data/gold/IberFire_coarse8_time1.zarr
      - NORM_STATS_PATH=/app/stats/simple_iberfire_stats_train.json
      - MODEL_PATH=/app/models
      - MODEL_FILE=resnet34_v9.torchscript

      # Must match training behavior
      - LABEL_VAR=is_fire
      - LEAD_TIME=1
      - TIME_START=2008-01-01
      - TIME_END=2024-12-31

      # Device selection
      - TORCH_DEVICE=cpu

      # Streamlit stability in containers
      - STREAMLIT_BROWSER_GATHER_USAGE_STATS=false
      - STREAMLIT_SERVER_HEADLESS=true
      - HOME=/tmp
      - XDG_CONFIG_HOME=/tmp
      - XDG_CACHE_HOME=/tmp

      # Make your repo code importable (for src.data.datasets)
      - PYTHONPATH=/workspace

    volumes:
      # Mount your repo for dataset code access (read-only)
      - ./:/workspace:ro

      # Mount data/model/stats explicitly (read-only)
      - ./data:/app/data:ro
      - ./models:/app/models:ro
      - ./stats:/app/stats:ro

    command: streamlit run /workspace/docker/monolith/app.py --server.port=8501 --server.address=0.0.0.0