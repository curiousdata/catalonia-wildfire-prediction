version: "3.9"

services:
  backend:
    build:
      context: ./backend
    container_name: backend-service
    ports:
      - "8000:8000"
    environment:
      - NORM_STATS_PATH=/app/stats/simple_iberfire_stats_train.json
      - MODEL_PATH=/app/models
      - MODEL_FILE=resnet34_v9.torchscript
      - DATA_PATH=/app/data
      - IBERFIRE_ZARR_PATH=/app/data/gold/IberFire_coarse8_time1.zarr
      # Optional: allow switching device in code (cpu/mps/cuda). Backend should default safely.
      - TORCH_DEVICE=cpu
      - PYTHONPATH=/app:/workspace/train_src
      - FEATURE_VARS=FAPAR,FWI,LAI,LST,NDVI,RH_max,RH_mean,RH_min,RH_range,SWI_001,SWI_005,SWI_010,SWI_020,is_holiday,surface_pressure_max,surface_pressure_mean,surface_pressure_min,surface_pressure_range,t2m_max,t2m_mean,t2m_min,t2m_range,total_precipitation_mean,wind_direction_at_max_speed,wind_direction_mean,wind_speed_max,wind_speed_mean,CLC_1,CLC_2,CLC_3,CLC_4,CLC_5,CLC_6,CLC_7,CLC_8,CLC_9,CLC_10,CLC_11,CLC_12,CLC_13,CLC_14,CLC_15,CLC_16,CLC_17,CLC_18,CLC_19,CLC_20,CLC_21,CLC_22,CLC_23,CLC_24,CLC_25,CLC_26,CLC_27,CLC_28,CLC_29,CLC_30,CLC_31,CLC_32,CLC_33,CLC_34,CLC_35,CLC_36,CLC_37,CLC_38,CLC_39,CLC_40,CLC_41,CLC_42,CLC_43,CLC_44,CLC_agricultural_proportion,CLC_arable_land_proportion,CLC_artificial_proportion,CLC_artificial_vegetation_proportion,CLC_forest_and_semi_natural_proportion,CLC_forest_proportion,CLC_heterogeneous_agriculture_proportion,CLC_industrial_proportion,CLC_inland_waters_proportion,CLC_inland_wetlands_proportion,CLC_marine_waters_proportion,CLC_maritime_wetlands_proportion,CLC_mine_proportion,CLC_open_space_proportion,CLC_permanent_crops_proportion,CLC_scrub_proportion,CLC_urban_fabric_proportion,CLC_waterbody_proportion,CLC_wetlands_proportion,aspect_1,aspect_2,aspect_3,aspect_4,aspect_5,aspect_6,aspect_7,aspect_8,aspect_NODATA,dist_to_railways_mean,dist_to_railways_stdev,dist_to_roads_mean,dist_to_roads_stdev,dist_to_waterways_mean,dist_to_waterways_stdev,elevation_mean,elevation_stdev,is_natura2000,is_sea,is_spain,is_waterbody,roughness_mean,roughness_stdev,slope_mean,slope_stdev,popdens
    volumes:
      # Live-reload convenience for MVP development
      - ./backend:/app
      - ../src:/workspace/train_src:ro
      # Mount canonical MVP models folder (relative to MVP compose file)
      - ./models:/app/models
      - ../data:/app/data
      - ../stats:/app/stats
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
    container_name: frontend-service
    ports:
      - "8501:8501"
    environment:
      # Frontend should call the backend via service name on the compose network
      - BACKEND_URL=http://backend:8000
    volumes:
      # Live-reload convenience for MVP development
      - ./frontend:/app
    depends_on:
      - backend
    restart: unless-stopped